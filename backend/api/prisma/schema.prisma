generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum BlockChannel {
  whatsapp
  email
}

model Block {
  channel  BlockChannel @default(whatsapp)
  id       Int
  name     String
  capacity Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([channel, id])
  @@index([channel])
}

enum RecipientChannel {
  whatsapp
  email
}

model Recipient {
  id      Int              @id @default(autoincrement())
  channel RecipientChannel @default(email)

  name    String  @default("")
  email   String?
  phone   String?
  tags    String  @default("")
  blockId Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  whatsappMessages      WhatsappMessage[]
  whatsappCampaignItems WhatsappCampaignItem[]

  @@index([channel])
  @@index([channel, blockId])
  @@index([email])
  @@index([phone])

  @@unique([channel, email])
  @@unique([channel, phone])
}

model Attachment {
  id           Int      @id @default(autoincrement())
  originalName String
  filename     String   @unique
  mimeType     String
  size         Int
  createdAt    DateTime @default(now())

  whatsappCampaigns WhatsappCampaign[]
}

model Setting {
  key   String @id
  value String

  @@map("settings")
}

/**
 * =========================
 * WhatsApp
 * =========================
 */

enum WhatsappMessageStatus {
  pending
  sent
  delivered
  read
  failed
}

model WhatsappMessage {
  id   String @id @default(cuid())
  to   String
  body String

  whapiMessageId String?               @unique
  status         WhatsappMessageStatus @default(pending)
  error          String?

  recipientId Int?
  recipient   Recipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)

  clientRef String?

  campaignItemId String?
  campaignItem   WhatsappCampaignItem? @relation("WaItemMessages", fields: [campaignItemId], references: [id], onDelete: SetNull)

  lastForItem WhatsappCampaignItem? @relation("WaItemLastMessage")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  @@index([status])
  @@index([to])
  @@index([createdAt])
  @@index([campaignItemId])
}

model WhatsappWebhookLog {
  id        String   @id @default(cuid())
  event     String?
  messageId String?
  status    String?
  payload   Json
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([messageId])
}

/**
 * ✅ NUEVO: inbound messages (dedupe + auditoría + link a campaña)
 */
model WhatsappInboundMessage {
  id            String   @id @default(cuid())
  whapiMessageId String  @unique
  from          String
  chatId        String?
  type          String?
  body          String?
  fromMe        Boolean  @default(false)
  payload       Json
  createdAt     DateTime @default(now())

  campaignId    String?
  campaign      WhatsappCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  campaignItemId String?
  campaignItem   WhatsappCampaignItem? @relation(fields: [campaignItemId], references: [id], onDelete: SetNull)

  @@index([from])
  @@index([createdAt])
  @@index([campaignId])
  @@index([campaignItemId])
}

enum WhatsappCampaignStatus {
  draft
  running
  paused
  done
  cancelled
  failed
}

enum WhatsappCampaignItemStatus {
  pending
  sending
  sent
  delivered
  read
  failed
  skipped
}

enum WhatsappCampaignMediaType {
  text
  image
  video
  document
}

model WhatsappCampaign {
  id     String                 @id @default(cuid())
  name   String                 @default("Campaña WhatsApp")
  status WhatsappCampaignStatus @default(draft)

  blockId        Int?
  tags           String?
  requireAllTags Boolean @default(false)

  body       String  @default("")
  delayMs    Int     @default(2500)
  maxRetries Int     @default(2)

  mediaType    WhatsappCampaignMediaType @default(text)
  attachmentId Int?
  attachment   Attachment? @relation(fields: [attachmentId], references: [id], onDelete: SetNull)

  scheduledAt DateTime?

  total          Int @default(0)
  doneCount      Int @default(0)
  sentCount      Int @default(0)
  deliveredCount Int @default(0)
  readCount      Int @default(0)
  failedCount    Int @default(0)
  skippedCount   Int @default(0)

  // ✅ NUEVO (ventas / bot)
  repliedCount     Int @default(0) // cantidad de destinatarios que respondieron al menos 1 vez
  autoRepliedCount Int @default(0) // cantidad de auto-respuestas enviadas

  startedAt  DateTime?
  finishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items WhatsappCampaignItem[]
  inboundMessages WhatsappInboundMessage[]

  @@index([status])
  @@index([createdAt])
  @@index([scheduledAt])
}

model WhatsappCampaignItem {
  id         String           @id @default(cuid())
  campaignId String
  campaign   WhatsappCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  recipientId Int?
  recipient   Recipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)

  to          String
  name        String?
  tagsSnap    String?
  blockIdSnap Int?

  status        WhatsappCampaignItemStatus @default(pending)
  attempts      Int                        @default(0)
  lastError     String?
  lastAttemptAt DateTime?
  nextAttemptAt DateTime?

  messageId String?          @unique
  message   WhatsappMessage? @relation("WaItemLastMessage", fields: [messageId], references: [id], onDelete: SetNull)

  messages WhatsappMessage[] @relation("WaItemMessages")

  // ✅ NUEVO (ventas / bot)
  replyCount       Int      @default(0)
  firstReplyAt     DateTime?
  lastReplyAt      DateTime?
  autoReplyCount   Int      @default(0)
  lastAutoReplyAt  DateTime?

  inboundMessages WhatsappInboundMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@index([status])
  @@index([to])
  @@index([nextAttemptAt])
  @@index([firstReplyAt])
}